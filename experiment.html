<!DOCTYPE html>
<html>
	<head>
		<title>My experiment</title>
		<script src="https://unpkg.com/jspsych@7.3.2"></script>
		<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
		<script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
		<script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
		<link
			href="https://unpkg.com/jspsych@7.3.2/css/jspsych.css"
			rel="stylesheet"
			type="text/css"
		/>
	</head>
	<body></body>
	<script>
		/* initialize jsPsych */
		var jsPsych = initJsPsych({
			on_finish: function () {
				jsPsych.data.displayData();
			},
		});

		// タイムラインを定義
		var timeline = [];
		// 画像をプリロード
		var preload = {
			type: jsPsychPreload,
			images: [
				"img/frac_AB.png",
				"img/frac_AC.png",
				"img/frac_AD.png",
				"img/frac_BA.png",
				"img/frac_BC.png",
				"img/frac_BD.png",
				"img/frac_CA.png",
				"img/frac_CB.png",
				"img/frac_CD.png",
				"img/frac_DA.png",
				"img/frac_DB.png",
				"img/frac_DC.png",
			],
		};
		timeline.push(preload);

		/* define welcome message trial */
		var welcome = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: "Welcome to the experiment. Press any key to begin.",
		};
		timeline.push(welcome);

		/* define instructions trial */
		var instructions = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: `
				<p>色々と説明しています！</p>
				<p>左を選ぶ場合は「f」を、右を選ぶ場合は「j」を押してください。</p>
			`,
			post_trial_gap: 1000,
		};
		timeline.push(instructions);

		/* define trial stimuli array for timeline variables */

		var test_stimuli = [
			{
				stimulus: "img/frac_AB.png",
				response_type: "AB",
			},
			{
				stimulus: "img/frac_CA.png",
				response_type: "CA",
			},
			{
				stimulus: "img/frac_AD.png",
				response_type: "AD",
			},
			{
				stimulus: "img/frac_CB.png",
				response_type: "CB",
			},
			{
				stimulus: "img/frac_BD.png",
				response_type: "BD",
			},
			{
				stimulus: "img/frac_DC.png",
				response_type: "DC",
			},
			{
				stimulus: "img/frac_BA.png",
				response_type: "BA",
			},
			{
				stimulus: "img/frac_AC.png",
				response_type: "AC",
			},
			{
				stimulus: "img/frac_DA.png",
				response_type: "DA",
			},
			{
				stimulus: "img/frac_BC.png",
				response_type: "BC",
			},
			{
				stimulus: "img/frac_CA.png",
				response_type: "CA",
			},
			{
				stimulus: "img/frac_DB.png",
				response_type: "DB",
			},
		];
		var fixation = {
			//
			type: jsPsychHtmlKeyboardResponse,
			stimulus: '<div style="font-size:60px;">+</div>',
			choices: "NO_KEYS",
			trial_duration: 500,
			// このtrialのデータを保存する
			data: {
				task: "fixation",
			},
		};

		function return_fb(order, response) {
			console.log("order: " + order + ", response: " + response);
			var cut_index = 0;
			if (response == "j") {
				cut_index = 1;
			}
			var p_choice = order.slice(cut_index, cut_index + 1);
			console.log("p_choice: " + p_choice);

			if (p_choice == "A") {
				return {
					choice: p_choice,
					generosity: 0.2,
					reward: 20,
					pool: 100,
				};
			} else if (p_choice == "B") {
				return {
					choice: p_choice,
					generosity: 0.4,
					reward: 10,
					pool: 25,
				};
			} else if (p_choice == "C") {
				return {
					choice: p_choice,
					generosity: 0.4,
					reward: 20,
					pool: 50,
				};
			} else if (p_choice == "D") {
				return {
					choice: p_choice,
					generosity: 0.2,
					reward: 10,
					pool: 50,
				};
			}
		}

		var tmp_order = "";
		var tmp_response = "";
		var tmp_fb_dict = {};
		var test = {
			type: jsPsychImageKeyboardResponse,
			stimulus: jsPsych.timelineVariable("stimulus"),
			choices: ["f", "j"],
			data: {
				task: "choice",
				correct_response: jsPsych.timelineVariable("response_type"),
			},
			on_finish: function (data) {
				tmp_order = jsPsych.timelineVariable("response_type");
				tmp_response = data.response;
				tmp_fb_dict = return_fb(tmp_order, tmp_response);
				// data.response_img = tmp_img;

				console.log("tmp_response: " + tmp_response);
				console.log("tmp_order: " + tmp_order);
				console.log("tmp_chioce: " + tmp_fb_dict.choice);
			},
		};

		var feedback = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: function () {
				return `
				<img src="img/fractal_${tmp_fb_dict.choice}.png" width="60%">
				<p>あなたに<strong>${tmp_fb_dict.reward}</strong>ポイントが与えられました。</p>
				<p>相手は<strong>${tmp_fb_dict.reward}</strong>ポイント保有しました。</p>
				`;
			},
		};

		/* define test procedure */
		var test_procedure = {
			timeline: [fixation, test, feedback],
			timeline_variables: test_stimuli,
			repetitions: 1,
			randomize_order: true,
		};
		timeline.push(test_procedure);

		var debrief_block = {
			type: jsPsychHtmlKeyboardResponse,
			stimulus: "<p>お疲れ様でした。終了です。</p>",
		};
		timeline.push(debrief_block);

		// save data
		var save_data = {
			type: "csv",
			fileName: "data.csv",
			data: jsPsych.data.get().csv(),
		};

		/* start the experiment */
		jsPsych.run(timeline);
	</script>
</html>
